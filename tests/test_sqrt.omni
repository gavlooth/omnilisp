;; test_sqrt.omni - Tests for square root function
;;
;; Tests prim_sqrt (exposed as sqrt in OmniLisp)
;; which computes the square root of a number.
;;
;; Run with: ./omni tests/test_sqrt.omni

;; ============================================================
;; Test Framework
;; ============================================================

(define test-count 0)
(define pass-count 0)
(define fail-count 0)

(define test-approx [name] [expected] [actual]
  (set! test-count (+ test-count 1))
  (let [tolerance 1e-10]
    (if (and (number? expected)
             (number? actual)
             (<= (abs (- expected actual)) tolerance))
        (do
          (set! pass-count (+ pass-count 1))
          (print "PASS:" name))
        (do
          (set! fail-count (+ fail-count 1))
          (print "FAIL:" name)
          (print "  Expected:" expected)
          (print "  Got:" actual)
          (print "  Diff:" (abs (- expected actual)))))))

(define test-true [name] [actual]
  (set! test-count (+ test-count 1))
  (if actual
      (do
        (set! pass-count (+ pass-count 1))
        (print "PASS:" name))
      (do
        (set! fail-count (+ fail-count 1))
        (print "FAIL:" name)
        (print "  Expected: true")
        (print "  Got: false"))))

;; ============================================================
;; Test 1: Basic Square Root Values
;; ============================================================

(print "")
(print "=== Test 1: Basic Square Root Values ===")

;; Test 1.1: sqrt(0) = 0
(test-approx "sqrt(0) = 0"
  0.0
  (sqrt 0))

;; Test 1.2: sqrt(1) = 1
(test-approx "sqrt(1) = 1"
  1.0
  (sqrt 1))

;; Test 1.3: sqrt(4) = 2
(test-approx "sqrt(4) = 2"
  2.0
  (sqrt 4))

;; Test 1.4: sqrt(9) = 3
(test-approx "sqrt(9) = 3"
  3.0
  (sqrt 9))

;; Test 1.5: sqrt(16) = 4
(test-approx "sqrt(16) = 4"
  4.0
  (sqrt 16))

;; ============================================================
;; Test 2: Non-Perfect Squares
;; ============================================================

(print "")
(print "=== Test 2: Non-Perfect Squares ===")

;; Test 2.1: sqrt(2) ≈ 1.41421356237
(test-approx "sqrt(2) ≈ 1.41421356237"
  1.4142135623730951
  (sqrt 2))

;; Test 2.2: sqrt(3) ≈ 1.73205080757
(test-approx "sqrt(3) ≈ 1.73205080757"
  1.7320508075688772
  (sqrt 3))

;; Test 2.3: sqrt(5) ≈ 2.2360679775
(test-approx "sqrt(5) ≈ 2.2360679775"
  2.23606797749979
  (sqrt 5))

;; Test 2.4: sqrt(10) ≈ 3.16227766017
(test-approx "sqrt(10) ≈ 3.16227766017"
  3.1622776601683795
  (sqrt 10))

;; ============================================================
;; Test 3: Fractional Values
;; ============================================================

(print "")
(print "=== Test 3: Fractional Values ===")

;; Test 3.1: sqrt(0.25) = 0.5
(test-approx "sqrt(0.25) = 0.5"
  0.5
  (sqrt 0.25))

;; Test 3.2: sqrt(0.5) ≈ 0.70710678118
(test-approx "sqrt(0.5) ≈ 0.70710678118"
  0.7071067811865476
  (sqrt 0.5))

;; Test 3.3: sqrt(2.25) = 1.5
(test-approx "sqrt(2.25) = 1.5"
  1.5
  (sqrt 2.25))

;; ============================================================
;; Test 4: Large Numbers
;; ============================================================

(print "")
(print "=== Test 4: Large Numbers ===")

;; Test 4.1: sqrt(10000) = 100
(test-approx "sqrt(10000) = 100"
  100.0
  (sqrt 10000))

;; Test 4.2: sqrt(1000000) = 1000
(test-approx "sqrt(1000000) = 1000"
  1000.0
  (sqrt 1000000))

;; ============================================================
;; Test 5: Negative Numbers (Edge Case)
;; ============================================================

(print "")
(print "=== Test 5: Negative Numbers ===")

;; Test 5.1: sqrt of negative number returns NaN
;; NaN has the property that it's not equal to itself
(do
  (define negative-sqrt (sqrt -4))
  (test-true "sqrt(-4) returns NaN (not equal to itself)"
    (and (number? negative-sqrt)
         (not (= negative-sqrt negative-sqrt)))))

;; Test 5.2: sqrt(-1) returns NaN
(do
  (define negative-one-sqrt (sqrt -1))
  (test-true "sqrt(-1) returns NaN (not equal to itself)"
    (and (number? negative-one-sqrt)
         (not (= negative-one-sqrt negative-one-sqrt)))))

;; ============================================================
;; Test 6: Mathematical Identity
;; ============================================================

(print "")
(print "=== Test 6: Mathematical Identity ===")

;; Test 6.1: sqrt(x)² = x for non-negative x
(do
  (define x 25.0)
  (define result (* (sqrt x) (sqrt x)))
  (test-approx "sqrt(x)² ≈ x (for x = 25)"
    x
    result))

;; Test 6.2: sqrt(x)² = x for decimal x
(do
  (define x 7.5)
  (define result (* (sqrt x) (sqrt x)))
  (test-approx "sqrt(x)² ≈ x (for x = 7.5)"
    x
    result))

;; ============================================================
;; Test Results
;; ============================================================

(print "")
(print "=== Test Results ===")
(print "Total:" test-count)
(print "Passed:" pass-count)
(print "Failed:" fail-count)

(if (= fail-count 0)
    (print "ALL TESTS PASSED!")
    (print "SOME TESTS FAILED"))

;; Return count of failures (0 = success)
fail-count
